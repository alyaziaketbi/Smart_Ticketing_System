@page
@model SmartTicketingManagementApp.Pages.Requester.IndexModel
@{
}

<h2>Requester Dashboard</h2>
<p>Welcome requester! You can submit or view your support tickets here.</p>

<br />

<div class="d-flex justify-content-end mb-2">
    <button type="button"
            class="btn btn-dark"
            data-bs-toggle="modal"
            data-bs-target="#createTicketModal">
        + Create Ticket
    </button>
</div>

@if (Model.Items.Count == 0)
{
    <div class="alert alert-light border">No open tickets.</div>
}
else
{
    <div class="table-responsive">
        <table class="table align-middle">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Title</th>
                    <th>Status</th>
                    <th>Priority</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var t in Model.Items)
                {
                    <tr>
                        <td><code>ticket-@t.Id</code></td>
                        <td>@t.Subject</td>
                        <td><span class="badge bg-secondary">@t.Status.ToLower()</span></td>
                        <td>@(string.IsNullOrWhiteSpace(t.Priority) ? "—" : t.Priority)</td>
                        <td>@(t.CreatedAt?.ToString("MMM dd, yyyy") ?? "—")</td>
                        <td>
                            <button type="button"
                                    class="btn btn-sm btn-outline-primary"
                                    data-bs-toggle="modal"
                                    data-bs-target="#ticketModal"
                                    data-id="ticket-@t.Id"
                                    data-subject="@t.Subject"
                                    data-status="@t.Status"
                                    data-priority="@(t.Priority ?? "—")"
                                    data-created="@(t.CreatedAt?.ToString("MMM dd, yyyy, hh:mm tt") ?? "")"
                                    data-body="@t.Body">
                                View
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}


<!--Modal-->
<div class="modal fade" id="ticketModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow">
            <div class="modal-header">
                <h5 class="modal-title" id="ticketModalTitle">Ticket</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2">
                    <span class="badge bg-secondary" id="mStatus">status</span>
                    <span class="badge bg-outline" id="mPriority">priority</span>
                </div>

                <dl class="row small mb-3">
                    <dt class="col-sm-4">Ticket ID</dt>
                    <dd class="col-sm-8" id="mId"></dd>
                    <dt class="col-sm-4">Created</dt>
                    <dd class="col-sm-8" id="mCreated"></dd>
                </dl>

                <h6>Description</h6>
                <p id="mBody" class="mb-0"></p>
            </div>
        </div>
    </div>
</div>

<!-- Submit a Ticket -->

<div class="modal fade" id="createTicketModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow">
            <div class="modal-header">
                <h5 class="modal-title">Create New Ticket</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form method="post" asp-page-handler="Create">
                <div class="modal-body">
                    <p class="text-muted mb-3">Submit a support ticket and our team will get back to you soon.</p>

                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input name="Title" class="form-control" placeholder="Brief description of your issue" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea name="Description" class="form-control" rows="4"
                                  placeholder="Provide detailed information about your issue..."></textarea>
                    </div>

                    <div class="mb-1">
                        <label class="form-label">Priority</label>
                        <select name="Priority" class="form-select">
                            <option>Low</option>
                            <option selected>Medium</option>
                            <option>High</option>
                        </select>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-dark">Submit Ticket</button>
                </div>
            </form>
        </div>
    </div>
</div>


@section Scripts {
<script>
document.getElementById('ticketModal')?.addEventListener('show.bs.modal', function (ev) {
    const btn = ev.relatedTarget;
    if (!btn) return;

    const get = (name) => btn.getAttribute(name) || "";

    document.getElementById('ticketModalTitle').textContent = get('data-subject');
    document.getElementById('mStatus').textContent  = get('data-status').toLowerCase();
    document.getElementById('mPriority').textContent= get('data-priority');
    document.getElementById('mId').textContent      = get('data-id');
    document.getElementById('mCreated').textContent = get('data-created');
    document.getElementById('mBody').textContent    = btn.getAttribute('data-body') || "";
});
</script>
}

<style>
    /* tiny helper for an outline-looking badge */
    .badge.bg-outline {
        border: 1px solid #dee2e6;
        color: #333;
        background: #fff;
        font-weight: 500;
    }
</style>