@page
@model SmartTicketingManagementApp.Pages.Requester.IndexModel
@{
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
<h2>My Support Tickets</h2>
<p>Welcome @Model.UserName! You can submit or view your support tickets here.</p>
    </div>


    <button type="button"
            class="btn btn-dark rounded-3 d-flex align-items-center gap-2 px-3 py-2"
            data-bs-toggle="modal"
            data-bs-target="#createTicketModal">
        + Create Ticket
    </button>


</div>

<div class="row g-3 mb-4">
    <div class="col">
        <div class="card shadow-sm border-0 rounded-4 p-3 text-start bg-white">
            <div class="fw-bold text-muted">Total Tickets</div>
            <div class="fs-4 fw-semibold">@ViewData["TotalTickets"]</div>
        </div>
    </div>
    <div class="col">
        <div class="card shadow-sm border-0 rounded-4 p-3 text-start bg-white">
            <div class="fw-bold text-muted">Open</div>
            <div class="fs-4 fw-semibold">@ViewData["OpenTickets"]</div>
        </div>
    </div>

    <div class="col">
        <div class="card shadow-sm border-0 rounded-4 p-3 text-start bg-white">
            <div class="fw-bold text-muted">Assigned</div>
            <div class="fs-4 fw-semibold">@ViewData["AssignedTickets"]</div>
        </div>
    </div>

    <div class="col">
        <div class="card shadow-sm border-0 rounded-4 p-3 text-start bg-white">
            <div class="fw-bold text-muted">In Progress</div>
            <div class="fs-4 fw-semibold">@ViewData["InProgressTickets"]</div>
        </div>
    </div>
    <div class="col">
        <div class="card shadow-sm border-0 rounded-4 p-3 text-start bg-white">
            <div class="fw-bold text-muted">Resolved</div>
            <div class="fs-4 fw-semibold">@ViewData["ResolvedTickets"]</div>
        </div>
    </div>
    <div class="col">
        <div class="card shadow-sm border-0 rounded-4 p-3 text-start bg-white">
            <div class="fw-bold text-muted">Canceled</div>
            <div class="fs-4 fw-semibold">@ViewData["CanceledTickets"]</div>
        </div>
    </div>
</div>




@if (Model.Items.Count == 0)
{
    <div class="alert alert-light border">No open tickets.</div>
}
else
{

    <div class="card shadow-sm border-0 rounded-4 p-3 bg-white mt-3">
        <h6 class="fw-semibold mb-3">Your Tickets</h6>

        <div class="table-responsive">
            <table class="table align-middle mb-0">
                <thead class="border-bottom">
                    <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Status</th>
                        <th>Priority</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var t in Model.Items)
                    {
                        <tr>
                            <td><code>ticket-@t.Id</code></td>
                            <td>@t.Subject</td>
                            <td>
                                @if (string.IsNullOrWhiteSpace(t.Status))
                                {
                                    <span>—</span>
                                }
                                else
                                {
                                    <span class="badge status-badge @(t.Status.ToLower().Replace("_", "-"))">@t.Status.ToLower()</span>
                                }
                            </td>
                            <td>
                                @if (string.IsNullOrWhiteSpace(t.Priority))
                                {
                                    <span>—</span>
                                }
                                else
                                {
                                    <span class="badge priority-badge @t.Priority.ToLower()">@t.Priority</span>
                                }
                            </td>
                            <td>@(t.CreatedAt?.ToString("MMM dd, yyyy") ?? "—")</td>
                            <td>
                                <button type="button"
                                        class="btn btn-light border-0 d-flex align-items-center gap-2 text-dark p-0 view-btn"
                                        data-bs-toggle="modal"
                                        data-bs-target="#ticketModal"
                                        data-id="ticket-@t.Id"
                                        data-subject="@t.Subject"
                                        data-status="@t.Status"
                                        data-priority="@(t.Priority ?? "—")"
                                        data-created="@(t.CreatedAt?.ToString("MMM dd, yyyy, hh:mm tt") ?? "")"
                                        data-body="@t.Body"
                                        data-body="@t.Body"
                                        data-assigned="@t.AssignedTeamName"
                                        data-resolution="@t.Answer"
                                        data-cancel="@t.Answer"
                                        title="View Ticket">
                                    <i class="bi bi-eye"></i>
                                    <span>View</span>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

}


<!--Modal-->
<div class="modal fade" id="ticketModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow">
            <div class="modal-header">
                <h5 class="modal-title" id="ticketModalTitle">Ticket</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <!-- Status + Priority -->
            <div class="modal-body">
                <div class="mb-3 d-flex flex-wrap align-items-center gap-2">
                    <span id="mStatus" class="badge status-badge text-uppercase">status</span>
                    <span id="mPriority" class="badge priority-badge text-uppercase">priority</span>
                </div>

                <!-- Ticket Info (ID + Created) -->
                <div class="p-3 bg-light rounded-3 mb-3">
                    <div class="row small text-muted">
                        <div class="col-md-6 d-flex align-items-center gap-2 mb-3">
                            <i class="bi bi-tag"></i>
                            <div>
                                <div class="fw-semibold">Ticket ID</div>
                                <div id="mId"></div>
                            </div>
                        </div>
                        <div class="col-md-6 d-flex align-items-center gap-2">
                            <i class="bi bi-clock"></i>
                            <div>
                                <div class="fw-semibold">Created</div>
                                <div id="mCreated"></div>
                            </div>
                        </div>
                        <div class="col-md-4 d-flex align-items-center gap-2">
                            <i class="bi bi-people"></i>
                            <div>
                                <div class="fw-semibold">Assigned to</div>
                                <div id="mAssigned" class="nowrap">—</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Description -->
                <h6>Description</h6>
                <p id="mBody" class="mb-0"></p>

                <!-- Resolution Section -->
                <div id="resolutionBox" class="p-3 rounded-3 mt-3" style="background-color:#eaf7ea; border-left:4px solid #28a745; display:none;">
                    <h6 class="fw-semibold text-success mb-1">
                        <i class="bi bi-check-circle-fill"></i> Resolved
                    </h6>
                    <small class="text-muted d-block mb-1" id="resolvedBy"></small>
                    <p class="mb-0" id="resolutionText"></p>
                </div>

                <!-- Cancelled Section -->
                <div id="cancelledBox" class="p-3 rounded-3 mt-3"
                     style="background-color:#fdeaea; border-left:4px solid #dc3545; display:none;">
                    <h6 class="fw-semibold text-danger mb-2">
                        <i class="bi bi-exclamation-circle-fill me-1"></i> Status
                    </h6>
                    <p class="mb-1 text-danger" id="cancelledBy"></p>
                    <p class="mb-0" id="cancelledReason"></p>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- Submit a Ticket -->

<div class="modal fade" id="createTicketModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow">
            <div class="modal-header">
                <h5 class="modal-title">Create New Ticket</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form method="post" asp-page-handler="Create">
                <div class="modal-body">
                    <p class="text-muted mb-3">Submit a support ticket and our team will get back to you soon.</p>

                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input name="Title" class="form-control" placeholder="Brief description of your issue" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea name="Description" class="form-control" rows="4"
                                  placeholder="Provide detailed information about your issue..."></textarea>
                    </div>

                    <div class="mb-1">
                        <label class="form-label">Priority</label>
                        <select name="Priority" class="form-select">
                            <option>Low</option>
                            <option selected>Medium</option>
                            <option>High</option>
                        </select>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-dark">Submit Ticket</button>
                </div>
            </form>
        </div>
    </div>
</div>

@if (TempData["ToastMessage"] != null)
{
    <style>
        /* Light green success style (like Bootstrap alert-success) */
        .toast-success-light {
            background-color: #d1e7dd !important; /* Light success green */
            color: #0f5132 !important; /* Dark green success text */
            border-left: 5px solid #0f5132; /* Accent line */
        }
    </style>

    <div class="toast-container position-fixed top-50 start-50 translate-middle p-3">
        <div id="liveToast"
             class="toast toast-success-light show"
             role="alert" aria-live="assertive" aria-atomic="true"
             data-bs-autohide="true"
             data-bs-delay="3000">
            <!-- Auto-hide after 3 seconds -->

            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi bi-check-circle me-2"></i> @TempData["ToastMessage"]
                </div>
                <button type="button"
                        class="btn-close me-2 m-auto"
                        data-bs-dismiss="toast"
                        aria-label="Close"></button>
            </div>
        </div>
    </div>

    <script>
        // Bootstraps the toast on page load
        document.addEventListener('DOMContentLoaded', function () {
            var toastEl = document.getElementById('liveToast');
            var toast = new bootstrap.Toast(toastEl);
            toast.show();
        });
    </script>
}


@section Scripts {
<script>
document.getElementById('ticketModal')?.addEventListener('show.bs.modal', function (ev) {
    const btn = ev.relatedTarget;
    if (!btn) return;

    const get = (name) => btn.getAttribute(name) || "";

            const mStatus = document.getElementById('mStatus');
            const mPriority = document.getElementById('mPriority');

            // Set text
            mStatus.textContent = get('data-status').toLowerCase();
            mPriority.textContent = get('data-priority');

            // Reset old classes
            mStatus.className = 'badge status-badge text-uppercase';
            mPriority.className = 'badge priority-badge text-uppercase';

            // Add color classes dynamically
            const statusValue = get('data-status').toLowerCase().replace("_", "-");
            const priorityValue = get('data-priority').toLowerCase();

            mStatus.classList.add(statusValue);
            mPriority.classList.add(priorityValue);

            // Other info


    document.getElementById('ticketModalTitle').textContent = get('data-subject');
   // document.getElementById('mStatus').textContent  = get('data-status').toLowerCase();
   // document.getElementById('mPriority').textContent= get('data-priority');
    document.getElementById('mId').textContent      = get('data-id');
    document.getElementById('mCreated').textContent = get('data-created');
    document.getElementById('mBody').textContent    = btn.getAttribute('data-body') || "";
    document.getElementById('mAssigned').textContent = get('data-assigned') || "—";

            // ---- Resolution (only if resolved) ----
            const resolutionBox = document.getElementById('resolutionBox');
            const resolutionText = get('data-resolution');
            const isResolved = get('data-status').toLowerCase() === "resolved";
                    const assignedTeam = get('data-assigned') || "";

            if (isResolved && resolutionText) {
                document.getElementById('resolutionText').textContent = resolutionText;
                        document.getElementById('resolvedBy').textContent = `Resolved by ${assignedTeam}`;
                resolutionBox.style.display = 'block';
            } else {
                resolutionBox.style.display = 'none';
            }

                    // --- Cancelled Section Logic ---
                const cancelledBox = document.getElementById('cancelledBox');
        const cancelText = get('data-cancel');

        if (statusValue === "canceled") {
            cancelledBox.style.display = "block";
            document.getElementById('cancelledBy').textContent = `This ticket has been cancelled by ${assignedTeam}.`;
            document.getElementById('cancelledReason').textContent = cancelText || "";
        } else {
            cancelledBox.style.display = "none";
        }

});
</script>
}

<style>
    /* Page background */
    body {
        background-color: #f8f9fa; /* light grey */
    }

    /* tiny helper for an outline-looking badge */
    .badge.bg-outline {
        border: 1px solid #dee2e6;
        color: #333;
        background: #fff;
        font-weight: 500;
    }

    .card {
        background-color: #fff;
        border-radius: 1rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        padding: 1rem 1.5rem;
        transition: transform 0.15s ease;
    }

        .card h6 {
            color: #333;
        }

        .card:hover {
            transform: translateY(-2px);
        }

    .stat-label {
        color: #6c757d; /* muted grey text */
        font-weight: 600;
        font-size: 0.95rem;
        text-align: left;
        margin-bottom: 0.3rem;
    }

    .stat-value {
        color: #000; /* black number */
        font-weight: 700;
        font-size: 1.3rem;
        text-align: left;
    }

    view-btn {
        text-decoration: none !important; /* removes underline */
        background: none;
        box-shadow: none;
    }

    .view-btn:hover {
        color: #f1f3f5; /* blue hover effect */
    }

    .view-btn i {
        font-size: 1.1rem;
    }

    /* Hover effect on table rows */
    .table tbody tr:hover {
        background-color: #f1f3f5; /* subtle grey */
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    /* Optional: make the table cleaner */
    .table {
        border-collapse: separate;
        border-spacing: 0 2px;
    }

    .modal-content {
        border-radius: 1rem;
    }

    .badge {
        font-weight: 600;
        font-size: 0.8rem;
        padding: 0.4em 0.75em;
    }

    .bg-light {
        background-color: #f8f9fa !important;
    }

    .fw-semibold {
        color: #212529;
    }

    .modal-body i {
        color: #6c757d;
    }

    <style >
    /* Base badge style */
    .badge {
        text-transform: capitalize;
        font-weight: 500;
        padding: 0.4em 0.7em;
        border-radius: 0.5rem;
        font-size: 0.8rem;
    }

    /* ===== PRIORITY COLORS ===== */
    .priority-badge.high {
        background-color: #dc3545; /* red */
        color: white;
    }

    .priority-badge.medium {
        background-color: #ffc107; /* yellow */
        color: #212529;
    }

    .priority-badge.low {
        background-color: #0d6efd; /* blue */
        color: white;
    }

    /* ===== STATUS COLORS ===== */
    .status-badge.open {
        background-color: #0d6efd; /* blue */
        color: white;
    }

    .status-badge.assigned {
        background-color: #6c757d; /* gray */
        color: white;
    }

    .status-badge.inprogress {
        background-color: #d63384; /* pink/magenta */
        color: white;
    }

    .status-badge.resolved {
        background-color: #198754; /* green */
        color: white;
    }

    .status-badge.canceled {
        background-color: #dc3545; /* red */
        color: white;
    }

    .toast.text-bg-success {
        background-color: #fff !important;
        color: #000 !important;
        border: 1px solid #ddd;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .nowrap {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 150px; /* adjust width as you want */
    }

    .ticket-info-item + .ticket-info-item {
        margin-top: 10px; /* adjust spacing */
    }
</style>